[View code on GitHub](https://github.com/ergoplatform/ergo/papers/yellow/sync.tex)

The code in this file is responsible for the synchronization of blockchain modifiers in the Ergo project. Modifiers can be in one of five states: Unknown, Requested, Received, Held, or Invalid. The goal of the synchronization process is to move modifiers from the Unknown state to the Held state. The success path for a modifier is Unknown -> Requested -> Received -> Held. If something goes wrong, such as the modifier not being delivered, it goes back to the Unknown state (if the node is going to receive it in the future) or to the Invalid state (if the node is not going to receive this modifier anymore).

The code is split into two parts: protocol and implementation. The protocol part describes the different ways a modifier can move from the Unknown state to the Requested state. One way is through the Inv protocol, where a node sends an Inv message to another node containing a pair of ModifierTypeId and Seq[ModifierId]. The receiving node filters out modifiers that are not in the Unknown state and requests the remaining modifiers from the peer that sent the Inv message. Another way is through headers synchronization, where a node synchronizes its headers chain with the network. The node calculates an ErgoSyncInfo message containing the ids of the last ErgoSyncInfo.MaxBlockIds headers and sends it to peers. The node also sends an ErgoSyncInfo message every time the headers chain is not synced yet, but the number of requested headers is small enough. The third way is through block section synchronization, where a node synchronizes block sections for headers starting at the height of the best full block that are in the Unknown state.

The implementation part describes how a modifier moves from the Requested state to the Received state and then to the Held state. When a node requests a modifier from another peer, it puts the modifier and corresponding peer to a special map called requested in DeliveryTracker and sends a CheckDelivery message to itself with a deliveryTimeout delay. When the node receives the modifier, it performs initial validation. If the modifier is invalid, the node penalizes the peer and moves the modifier to the Invalid state. If the peer has provided incorrect modifier bytes, the node penalizes the peer and moves the modifier to the Unknown state. If everything is fine, the node sends the modifier to NodeViewHolder (NVH) and sets the modifier to the Received state. When NVH receives new modifiers, it puts them to modifiersCache and applies as many modifiers from the cache as possible. NVH publishes a SyntacticallySuccessfulModifier message for every applied modifier, and when NVS receives this message, it moves the modifier to the Held state.

In summary, this code is responsible for the synchronization of blockchain modifiers in the Ergo project. It provides a protocol for moving modifiers from the Unknown state to the Requested state and an implementation for moving modifiers from the Requested state to the Received state and then to the Held state. This code is essential for maintaining the integrity of the blockchain and ensuring that all nodes in the network have the same view of the blockchain.
## Questions: 
 1. What are the different states that a modifier can be in during the synchronization process?
- The different states that a modifier can be in during the synchronization process are: Unknown, Requested, Received, Held, and Invalid.

2. How does a node request a modifier from another peer?
- When a node receives an Inv message from another peer, it filters out modifiers that are not in the Unknown state and requests the remaining modifiers from the peer that sent the Inv message. The modifier then goes into the Requested state.

3. What happens if a modifier is not delivered after a certain number of checks?
- If a modifier is not delivered after a certain number of checks, the node penalizes the peer (if not requested from a random peer) and stops expecting the modifier. The modifier then goes into the Unknown state.